files:
  "C:\\certs\\install-cert.ps1":
     content: |
              Try
              {
                    Remove-Item c:\Deployment -Force -Recurse -ErrorAction SilentlyContinue
                    Expand-Archive -LiteralPath C:\cfn\ebdata\source_bundle.zip -DestinationPath c:\Deployment -ErrorAction SilentlyContinue

                        function installsevice($servicename,$svc_dir,$svc_folder)
                        {
                          $svc_exist=Get-Service -Name $servicename -ErrorAction SilentlyContinue
                            
                              if($svc_exist -ne $null)
                              {
                                    C:\Windows\Microsoft.NET\Framework\v4.0.30319\installutil -u $svc_dir\"$servicename_exe.exe"
                                    Start-Sleep 5
                                    if($LASTEXITCODE -eq 0){write-host "OK"} else {  Write-Error "Error"}  
                                    Remove-Item $svc_dir -Force -Recurse
                              }
                          $svc_exist=Get-Service -Name $servicename -ErrorAction SilentlyContinue
                      
                              if($svc_exist -eq $null)
                              {
                                new-item $svc_dir -ItemType Directory -Force -ErrorAction SilentlyContinue
                                Copy-Item "C:\Deployment\$svc_folder\*" $svc_dir -Force -Recurse
                                C:\Windows\Microsoft.NET\Framework\v4.0.30319\installutil $svc_dir\"$servicename_exe.exe" 
                                if($LASTEXITCODE -eq 0){write-host "OK"} else {  Write-Error "Error"}  
                              }

                              Start-Sleep 5
                              Get-Service -Name $servicename | Start-Service
                              Start-Sleep 5
                            
                          $checkstatus=(Get-Service -Name $servicename -ErrorAction SilentlyContinue).Status
                            if($checkstatus -eq 'Running')
                            {
                                write-host "Service is up and running"
                            }
                            else
                            {

                                write-host "Error: Sending failed singnal to EB" `n
                                Remove-Item C:\Deployment -Force -Recurse -ErrorAction stop 
                                exit 1
                            }
                            
                            
                        }
                      
              #INSTALLING SERICES
              #===================

              # ###EngageWebService###
              $svc_dir="C:\Services\EngageWebService"
              $servicename_exe="EngageWebService"
              $servicename='EWSService'
              $svc_folder="EngageWebService-Build"
              installsevice $servicename $svc_dir $svc_folder

              Write-Host "Successfully installed all services.."

              #INSTALLING WEB
              #===================
              #Write-Host "Deploying WEB contents."
              Write-Host "Web app is up and running...."
              }
              catch
              {
              Write-Host $_.Exception.Message`n -ForegroundColor Red
                write-host "Error: Sending failed singnal to EB" `n
                Remove-Item C:\Deployment -Force -Recurse -ErrorAction SilentlyContinue
                exit 1
              }

container_commands:
  00_install_ssl:
    command: powershell -NoProfile -ExecutionPolicy Bypass -file C:\\certs\\install-cert.ps1
    waitAfterCompletion: 60    